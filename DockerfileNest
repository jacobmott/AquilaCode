
# Stage 1: Build with node image with NX
#Get node image
#copy entire cwd for nx app over
#npm install
#npm install nx globally
#nx build nest-app --prod
#expose port 3000

# Stage 2: deploy/run with node
#Get an node image
#copy the dist folder from the nx build over to the nginx image
#expose port 80
#run node


# Stage 1: build with node
#Get node image
FROM node:22-alpine3.20 AS development

#copy entire cwd for nx app over
COPY . ./AquilaCode/

WORKDIR /AquilaCode/

#npm install
RUN npm install --no-audit

# Install NX build system
#npm install nx globally
RUN npm i -g nx

#Build the nest app
RUN nx build nest-app --prod

# Stage 2: deploy/run with node
#Get an node image
FROM node:22-alpine3.20 AS production


#copy the dist folder from the nx build over to the node image
COPY --from=development /AquilaCode/dist/nest-app/ /AquilaCode/
COPY --from=development /AquilaCode/package.json /AquilaCode/
COPY --from=development /AquilaCode/package-lock.json /AquilaCode/

WORKDIR /AquilaCode

RUN npm install --no-audit

#expose port 80
#EXPOSE 80
#expose port 3000
#EXPOSE 3000

#run nginx
#ENTRYPOINT ["tail", "-f", "/dev/null"]
CMD ["node", "main.js"]
#CMD ["nginx", "-g", "daemon off;"]